<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M|Activity Performance Region Sumatera</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        /* CSS Disederhanakan dan Digabungkan */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            padding: 20px;
            margin: 0;
        }
        .container {
            width: 98%;
            max-width: 98%;
            margin: 0 auto;
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
        }
        #chart-container {
            position: relative;
            width: 98%;
            height: 300px; /* HEIGHT DITENTUKAN DI SINI */
            margin: 20px auto;
        }

        h2 {
            color: white;
            background-color: purple;
            padding: 10px;
            border-radius: 5px;
        }
        h3 {
            text-align: center;
            font-size: 13px;
            font-style: italic;
            font-weight: lighter;
            margin: 10px 0;
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 10px;
            justify-content: flex-start;
        }
        #branch-checkboxes {
            text-align: left; 
            padding: 10px 0; 
            border-top: 1px solid #ddd; 
            margin-top: 10px;
            width: 100%; /* Memastikan wadah checkbox penuh lebar */
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }
        #branch-checkboxes label {
            margin-right: 20px;
            font-size: 14px;
            white-space: nowrap; /* Mencegah nama cabang terpotong */
        }
        input[type="text"], select {
            width: auto;
            max-width: 300px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            flex-grow: 1;
        }
        .reset-btn, .print-btn {
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            background: green;
        }
        .reset-btn:hover {
            background: darkgreen;
        }
        .back-btn {
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            background: red;
        }
        .back-btn:hover {
            background: darkred;
        }
        .print-btn {
            background: #28a745;
            margin-top: 20px;
        }

        /* Gaya Tabel */
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1px;
            font-size: 13px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        td {
            text-align: left;
            white-space: nowrap;
        }
        table td:nth-child(n+3){
            text-align: center;
        }
        th {
            background-color: purple;
            color: white;
        }

        /* Mobile Responsiveness Disederhanakan */
        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
            }
            input, select, .reset-btn, .back-btn, .print-btn {
                width: 100%;
            }
            #branch-checkboxes {
                text-align: center;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>M-Activity Performance Region Sumatera on December 2025</h2>
        <div id="chart-container">
            <canvas id="myBarChart"></canvas>
        </div>

        <div class="filter-container">
            <select id="BranchFilter">
                <option value="">Main Branch</option>
                </select>
            <select id="OfficeFilter">
                <option value="">Office</option>
                </select>
            <button class="reset-btn" onclick="resetFilter()">Reset</button>
            <button class="back-btn" onclick="openPage()">Back</button>
            <h3><p id="time-date"></p></h3>
        </div>

        <div id="branch-checkboxes">
            </div>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHead"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    <br>
    </div>

    <button class="print-btn" onclick="printTable()">Print / Save PDF</button>

<script>
// app.js
const ChartDataLabels = window.ChartDataLabels;
const REPO_NAME = 'm-activity';
const BASE_PATH = './';
let myChart = null;
let tableData = [];
let allOffices = new Set();
let allBranches = new Set();
// VARIABEL BARU UNTUK MELACAK CABANG YANG DICENTANG DI CHART
let selectedBranchesForChart = new Set();

document.addEventListener('DOMContentLoaded', function() {
    // Asumsi: Dataset.json ada di path yang sama
    fetch('Dataset.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Gagal memuat Dataset.json. Pastikan file ada.');
            }
            return response.json();
        })
        .then(data => {
            populateTable(data);
            // Inisialisasi Checkbox setelah data dimuat
            populateBranchCheckboxes(); 
            
            // Inisialisasi filter dan chart
            filterAndSearchTable();

            document.getElementById('BranchFilter').addEventListener('change', function() {
                updateOfficeFilter(this.value);
            });
            document.getElementById('OfficeFilter').addEventListener('change', function() {
                filterAndSearchTable();
            });
        })
        .catch(error => {
            console.error('Error loading JSON:', error);
            drawChart({ labels: ['Gagal Memuat Data'], values: [0] });
        });
        
    updateTimeDate();
    setInterval(updateTimeDate, 1000);
});

function updateTimeDate() {
    const now = new Date();
    const time = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: "2-digit" });
    const date = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
    document.getElementById("time-date").innerHTML = `${date} | ${time}`;
}
    
function sortDataByValue(data, sortOrder = 'desc') {
    const pairedData = data.labels.map((label, index) => ({
        label: label,
        value: data.values[index]
    }));

    pairedData.sort((a, b) => {
        return sortOrder === 'asc' ? a.value - b.value : b.value - a.value;
    });

    const sortedLabels = pairedData.map(item => item.label);
    const sortedValues = pairedData.map(item => item.value);

    return { labels: sortedLabels, values: sortedValues };
}

function getRandomColor(alpha = 1) {
    const r = Math.floor(Math.random() * 255);
    const g = Math.floor(Math.random() * 255);
    const b = Math.floor(Math.random() * 255);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function drawChart(data) {
    if (!data || data.labels.length === 0) {
        if (myChart) myChart.destroy();
        // Bersihkan canvas secara eksplisit jika tidak ada data
        const canvas = document.getElementById('myBarChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        return; 
    }
    const ctx = document.getElementById('myBarChart').getContext('2d');
    
    if (myChart) {
        myChart.destroy();
    }
    
    const staticColors = [
        'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)'
    ];

    const backgroundColors = data.labels.map((label, index) => {
        if (label.startsWith('TOTAL')) {
            return 'rgba(78, 51, 126, 0.9)'; 
        }
        return staticColors[index % staticColors.length];
    });

    myChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Office Activity',
                data: data.values,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { beginAtZero: true, grid: { display: false }, border: { display: false }, ticks: { maxRotation: 90, minRotation: 90 } },
                y: { beginAtZero: true, grid: { display: false }, border: { display: false }, ticks: { display: false } }
            },
            plugins: {
                datalabels: {
                    color: '#000',
                    font: { weight: 'normal' },
                    anchor: 'end',
                    align: 'end',
                    formatter: (value) => value.toLocaleString()
                },
            }
        }
    });
}

// FUNGSI BARU: MEMBUAT CHECKBOX UNTUK SETIAP MAIN BRANCH
function populateBranchCheckboxes() {
    const checkboxContainer = document.getElementById('branch-checkboxes');
    checkboxContainer.innerHTML = '<strong>Tampilkan Cabang di Chart:</strong> ';

    selectedBranchesForChart.clear();
    
    const sortedBranches = Array.from(allBranches).sort();

    sortedBranches.forEach(branch => {
        selectedBranchesForChart.add(branch); 
        
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        
        checkbox.type = 'checkbox';
        checkbox.value = branch;
        checkbox.checked = true;
        checkbox.style.marginRight = '5px';
        checkbox.onchange = handleBranchCheckboxChange;
        
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(branch));
        checkboxContainer.appendChild(label);
    });
}

// FUNGSI BARU: MENGELOLA PERUBAHAN CHECKBOX
function handleBranchCheckboxChange(event) {
    const branch = event.target.value;
    if (event.target.checked) {
        selectedBranchesForChart.add(branch);
    } else {
        selectedBranchesForChart.delete(branch);
    }
    filterAndSearchTable();
}

function updateOfficeFilter(selectedBranch) {
    const OfficeFilter = document.getElementById('OfficeFilter');
    
    OfficeFilter.innerHTML = '<option value="">Office</option>'; 
    
    if (selectedBranch === "") {
        updateFilterOptions(OfficeFilter, allOffices, 'Office');
    } else {
        let relevantOffices = new Set();
        tableData.forEach(row => {
            if (String(row['Main Branch']).toLowerCase() === selectedBranch.toLowerCase()) {
                relevantOffices.add(row['Office']);
            }
        });
        updateFilterOptions(OfficeFilter, relevantOffices, 'Office');
    }

    filterAndSearchTable();
}

function populateTable(data) {
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const OfficeFilter = document.getElementById('OfficeFilter');
    const BranchFilter = document.getElementById('BranchFilter');

    tableHead.innerHTML = '';
    tableBody.innerHTML = '';
    tableData = Array.isArray(data) ? data : [];

    allOffices.clear();
    allBranches.clear();

    if (tableData.length > 0) {
        // Membuat header tabel
        Object.keys(data[0]).forEach(header => {
            let th = document.createElement('th');
            th.textContent = header;
            tableHead.appendChild(th);
        });

        data.forEach(row => {
            // Membuat baris tabel dan mengisi Set filter
            let tr = document.createElement('tr');
            Object.values(row).forEach(cell => {
                let td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
            
            allOffices.add(row['Office']);
            allBranches.add(row['Main Branch']);
        });

        updateFilterOptions(OfficeFilter, allOffices, 'Office');
        updateFilterOptions(BranchFilter, allBranches, 'Main Branch');
    }
}

function updateFilterOptions(filterElement, values, defaultText) {
    filterElement.innerHTML = `<option value="">${defaultText}</option>`;
    const sortedValues = Array.from(values).sort();
    sortedValues.forEach(value => {
        let option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        filterElement.appendChild(option);
    });
}

function filterAndSearchTable() {
    if (!Array.isArray(tableData) || tableData.length === 0) {
        drawChart({ labels: [], values: [] });
        return;
    }
    const OfficeFilterElement = document.getElementById('OfficeFilter');
    const BranchFilterElement = document.getElementById('BranchFilter');

    const OfficeValue = OfficeFilterElement.value.toLowerCase();
    const BranchValue = BranchFilterElement.value.toLowerCase();
    const COLUMN_TO_TOTAL = 'Total';
    
    const branchesForChart = Array.from(selectedBranchesForChart).map(b => b.toLowerCase());

    // --- Langkah 1: Penyaringan Dasar Data (untuk Tabel dan Chart) ---
    const filteredData = tableData.filter(row => {
        const BranchMatch = BranchValue === "" || String(row['Main Branch']).toLowerCase() === BranchValue;
        const OfficeMatch = OfficeValue === "" || String(row['Office']).toLowerCase() === OfficeValue;
        return BranchMatch && OfficeMatch;
    });

    // --- Langkah 2: Logika Pengelompokan Chart ---
    let chartLabels = [];
    let chartValues = [];
    
    // Skenario 2: Branch spesifik dipilih & Office "All" (Mode Detail Office di bawah Branch)
    if (BranchValue !== "" && OfficeValue === "") {
        const chartTotals = new Map();
        let totalBranchActivity = 0;
        
        filteredData.forEach(row => {
            const officeName = row['Office'];
            const activityValue = parseFloat(row[COLUMN_TO_TOTAL]) || 0;
            
            const currentOfficeTotal = chartTotals.get(officeName) || 0;
            chartTotals.set(officeName, currentOfficeTotal + activityValue);
            totalBranchActivity += activityValue;
        });

        const totalLabel = `TOTAL ${BranchValue.toUpperCase()}`;
        chartTotals.set(totalLabel, totalBranchActivity);
        
        const officeLabels = Array.from(chartTotals.keys()).filter(k => !k.startsWith('TOTAL'));
        chartLabels = [totalLabel].concat(officeLabels);
        chartValues = chartLabels.map(label => chartTotals.get(label));
        
    } else {
        // Skenario 1 (Branch All, Office All) atau Skenario 4 (Office Spesifik)
        // Kita hitung total Main Branch yang lolos filter DROPDOWN DAN CHECKBOX
        
        const branchTotalsForChart = new Map(); 

        tableData.forEach(row => {
            const branchName = row['Main Branch'];
            const activityValue = parseFloat(row[COLUMN_TO_TOTAL]) || 0;
            
            const isChecked = branchesForChart.includes(branchName.toLowerCase());
            
            const BranchMatch = BranchValue === "" || String(row['Main Branch']).toLowerCase() === BranchValue;
            const OfficeMatch = OfficeValue === "" || String(row['Office']).toLowerCase() === OfficeValue;

            // Baris data harus lolos filter Dropdown DAN harus dicentang di Checkbox
            if (isChecked && BranchMatch && OfficeMatch) {
                 const currentTotal = branchTotalsForChart.get(branchName) || 0;
                 branchTotalsForChart.set(branchName, currentTotal + activityValue);
            }
        });
        
        chartLabels = Array.from(branchTotalsForChart.keys());
        chartValues = Array.from(branchTotalsForChart.values());
    }

    // --- Langkah 3: Gambar Ulang Chart ---
    if (chartLabels.length === 0) {
        drawChart({ labels: [], values: [] });
    } else {
        const chartDataResult = { labels: chartLabels, values: chartValues };
        
        let sortedChartData = chartDataResult;
        
        // Hanya sortir dan filter nilai > 0 jika BUKAN mode detail
        if (!(BranchValue !== "" && OfficeValue === "")) {
            const filteredChartData = chartDataResult.labels.map((label, index) => ({
                label: label,
                value: chartDataResult.values[index]
            })).filter(item => item.value > 0);
            
            const labelsNoZero = filteredChartData.map(item => item.label);
            const valuesNoZero = filteredChartData.map(item => item.value);

            sortedChartData = sortDataByValue({ labels: labelsNoZero, values: valuesNoZero }, 'desc');
        }

        drawChart(sortedChartData);
    }

    // --- Langkah 4: Perbarui Tampilan Tabel ---
    tableBody.innerHTML = '';
    filteredData.forEach(row => {
        let tr = document.createElement('tr');
        Object.values(row).forEach(cell => {
             let td = document.createElement('td');
             td.textContent = cell;
             tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });
}

function resetFilter() {
    document.getElementById('OfficeFilter').value = "";
    document.getElementById('BranchFilter').value = "";
    
    // Reset checkbox (semua dicentang)
    document.querySelectorAll('#branch-checkboxes input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
        selectedBranchesForChart.add(checkbox.value); 
    });
    
    updateOfficeFilter("");
    filterAndSearchTable(); 
}

function printTable() {
    let tableContent = document.getElementById("dataTable").outerHTML;
    let originalContent = document.body.innerHTML;

    // Sembunyikan tombol saat mencetak
    document.body.innerHTML = `
        <style>
            .print-btn, .filter-container, #branch-checkboxes { display: none; }
            h2, h3 { display: block; text-align: center; }
        </style>
        ${document.getElementById("dataTable").outerHTML}
    `;
    window.print();
    // Kembalikan konten asli
    document.body.innerHTML = originalContent;
    // Reload filter/chart jika diperlukan setelah print (opsional, tapi lebih aman)
    document.addEventListener('DOMContentLoaded', filterAndSearchTable); 
}
function openPage() {
    window.location.href = 'https://bmi-apps.github.io/regionsumatera/';
}
</script>
</body>
</html>
