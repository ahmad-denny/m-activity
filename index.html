<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M|Activity Performance Region Sumatera</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        /* CSS Disederhanakan dan Digabungkan */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            padding: 20px;
            margin: 0;
        }
        .container {
            width: 98%;
            max-width: 98%;
            margin: 0 auto;
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
        }
        #chart-container {
            position: relative;
            width: 98%;
            height: 600px; 
            margin: 20px auto;
            padding-top: 0; 
            padding-bottom: 0;
        }

        h2 {
            color: white;
            background-color: purple;
            padding: 10px;
            border-radius: 5px;
        }
        h3 {
            text-align: center;
            font-size: 13px;
            font-style: italic;
            font-weight: lighter;
            margin: 10px 0;
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 10px;
            justify-content: flex-start;
        }
        
        input[type="text"], select {
            width: auto;
            max-width: 300px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            flex-grow: 1;
        }
        .reset-btn, .print-btn {
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            background: green;
        }
        .reset-btn:hover {
            background: darkgreen;
        }
        .back-btn {
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            background: red;
        }
        .back-btn:hover {
            background: darkred;
        }
        .print-btn {
            background: #28a745;
            margin-top: 20px;
        }

        /* Gaya Tabel */
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1px;
            font-size: 13px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        td {
            text-align: left;
            white-space: nowrap;
        }
        table td:nth-child(n+3){
            text-align: center;
        }
        th {
            background-color: purple;
            color: white;
        }

        /* Mobile Responsiveness Disederhanakan */
        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
            }
            input, select, .reset-btn, .back-btn, .print-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>M-Activity Performance Region Sumatera on December 2025</h2>
        <div id="chart-container">
            <canvas id="myBarChart"></canvas>
        </div>

        <div class="filter-container">
            <select id="BranchFilter">
                <option value="">Main Branch</option>
            </select>
            <select id="OfficeFilter">
                <option value="">Office</option>
            </select>
            <select id="ActivityStatusFilter">
                <option value="all">Status Aktivitas (Semua)</option>
                <option value="active">Office Ada Aktivitas</option>
                <option value="inactive">Office Tidak Ada Aktivitas</option>
            </select>
            
            <button class="reset-btn" onclick="resetFilter()">Reset</button>
            <button class="back-btn" onclick="openPage()">Back</button>
            <h3><p id="time-date"></p></h3>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHead"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    <br>
    </div>

    <button class="print-btn" onclick="printTable()">Print / Save PDF</button>

<script>
// app.js
const ChartDataLabels = window.ChartDataLabels;
const REPO_NAME = 'm-activity';
const BASE_PATH = './';
let myChart = null;
let tableData = [];
let allOffices = new Set();
let allBranches = new Set();
let officeActivityTotals = new Map(); 


document.addEventListener('DOMContentLoaded', function() {
    // Memuat data dari Dataset.json
    fetch('Dataset.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Gagal memuat Dataset.json. Pastikan file ada.');
            }
            return response.json();
        })
        .then(data => {
            populateTable(data);
            filterAndSearchTable(); 

            // Event Listeners untuk Dropdown
            document.getElementById('BranchFilter').addEventListener('change', filterAndSearchTable);
            document.getElementById('OfficeFilter').addEventListener('change', filterAndSearchTable);
            document.getElementById('ActivityStatusFilter').addEventListener('change', filterAndSearchTable);

        })
        .catch(error => {
            console.error('Error loading JSON:', error);
            // Fallback draw chart jika data gagal dimuat
            drawChart({ labels: ['Gagal Memuat Data'], values: [0] });
        });
        
    updateTimeDate();
    setInterval(updateTimeDate, 1000);
});

function updateTimeDate() {
    const now = new Date();
    const time = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: "2-digit" });
    const date = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
    document.getElementById("time-date").innerHTML = `${date} | ${time}`;
}
    
function sortDataByValue(data, sortOrder = 'desc') {
    const pairedData = data.labels.map((label, index) => ({
        label: label,
        value: data.values[index]
    }));

    pairedData.sort((a, b) => {
        return sortOrder === 'asc' ? a.value - b.value : b.value - a.value;
    });

    const sortedLabels = pairedData.map(item => item.label);
    const sortedValues = pairedData.map(item => item.value);

    return { labels: sortedLabels, values: sortedValues };
}

function drawChart(data) {
    if (!data || data.labels.length === 0) {
        if (myChart) myChart.destroy();
        const canvas = document.getElementById('myBarChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        return; 
    }
    const ctx = document.getElementById('myBarChart').getContext('2d');
    
    if (myChart) {
        myChart.destroy();
    }
    
    const staticColors = [
        'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)'
    ];

    const backgroundColors = data.labels.map((label, index) => {
        if (label.startsWith('TOTAL')) {
            return 'rgba(78, 51, 126, 0.9)'; 
        }
        if (data.values[index] === 0) {
            return 'rgba(150, 150, 150, 0.7)'; // Abu-abu
        }
        return staticColors[index % staticColors.length];
    });

    const maxVal = data.values.length > 0 ? Math.max(...data.values) : 10;
    const suggestedMax = maxVal * 1.25; 


    myChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Office Activity',
                data: data.values,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(c => c.replace('0.7', '1').replace('0.8', '1').replace('0.9', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // Chart Horizontal
            
            scales: {
                x: { 
                    beginAtZero: true, 
                    suggestedMax: suggestedMax, 
                    grid: { display: false }, 
                    border: { display: false }, 
                    ticks: { display: false } 
                },
                y: { 
                    beginAtZero: true, 
                    grid: { display: true },
                    border: { display: true }, 
                    
                    padding: 0, 
                    
                    ticks: { 
                        display: true, 
                        mirror: false,
                        
                        align: 'center', 
                        
                        // **SOLUSI HALUS: Dorong label 1px ke bawah**
                        padding: {
                            top: 1, 
                            bottom: 0,
                            left: 0,
                            right: 0
                        },
                        
                        font: {
                            lineHeight: 1.2, 
                            size: 14,
                        }
                    },
                    offset: true, 
                    categoryPercentage: 0.9, 
                    barPercentage: 0.8, 
                }
            },
            plugins: {
                datalabels: {
                    color: '#000',
                    font: { weight: 'normal' },
                    anchor: 'end',
                    align: 'end',   
                    offset: 4,      
                    formatter: (value) => value.toLocaleString()
                },
            }
        }
    });
}

function updateOfficeFilter(selectedBranch) {
    const OfficeFilter = document.getElementById('OfficeFilter');
    
    OfficeFilter.innerHTML = '<option value="">Office</option>'; 
    
    if (selectedBranch === "") {
        updateFilterOptions(OfficeFilter, allOffices, 'Office');
    } else {
        let relevantOffices = new Set();
        tableData.forEach(row => {
            if (String(row['Main Branch']).toLowerCase() === selectedBranch.toLowerCase()) {
                relevantOffices.add(row['Office']);
            }
        });
        updateFilterOptions(OfficeFilter, relevantOffices, 'Office');
    }

    filterAndSearchTable();
}

function populateTable(data) {
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const OfficeFilter = document.getElementById('OfficeFilter');
    const BranchFilter = document.getElementById('BranchFilter');

    tableHead.innerHTML = '';
    tableBody.innerHTML = '';
    tableData = Array.isArray(data) ? data : [];

    allOffices.clear();
    allBranches.clear();
    officeActivityTotals.clear(); 

    if (tableData.length > 0) {
        Object.keys(data[0]).forEach(header => {
            let th = document.createElement('th');
            th.textContent = header;
            tableHead.appendChild(th);
        });

        data.forEach(row => {
            const branchName = row['Main Branch'];
            const officeName = row['Office']; 
            const activityValue = parseFloat(row['Total']) || 0; 

            allOffices.add(officeName);
            allBranches.add(branchName);

            const currentTotal = officeActivityTotals.get(officeName) || 0;
            officeActivityTotals.set(officeName, currentTotal + activityValue);
            
            let tr = document.createElement('tr');
            Object.values(row).forEach(cell => {
                let td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });

        updateFilterOptions(OfficeFilter, allOffices, 'Office');
        updateFilterOptions(BranchFilter, allBranches, 'Main Branch');
    }
}

function updateFilterOptions(filterElement, values, defaultText) {
    filterElement.innerHTML = `<option value="">${defaultText}</option>`;
    const sortedValues = Array.from(values).sort();
    sortedValues.forEach(value => {
        let option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        filterElement.appendChild(option);
    });
}

function filterAndSearchTable() {
    if (!Array.isArray(tableData) || tableData.length === 0) {
        drawChart({ labels: [], values: [] });
        return;
    }
    const OfficeFilterElement = document.getElementById('OfficeFilter');
    const BranchFilterElement = document.getElementById('BranchFilter');
    const ActivityStatusFilterElement = document.getElementById('ActivityStatusFilter');

    const OfficeValue = OfficeFilterElement.value.toLowerCase();
    const BranchValue = BranchFilterElement.value.toLowerCase();
    const ActivityStatusValue = ActivityStatusFilterElement.value; 
    
    // --- Langkah 1: Penyaringan Data (untuk Tabel) ---
    const filteredData = tableData.filter(row => {
        const BranchMatch = BranchValue === "" || String(row['Main Branch']).toLowerCase() === BranchValue;
        const OfficeMatch = OfficeValue === "" || String(row['Office']).toLowerCase() === OfficeValue;
        return BranchMatch && OfficeMatch;
    });

    // --- Langkah 2: Logika Pengelompokan Chart ---
    let chartLabels = [];
    let chartValues = [];
    
    let isDefaultView = (BranchValue === "" && OfficeValue === "");

    if (isDefaultView || (BranchValue !== "" && OfficeValue === "")) {
        const officesToChart = new Map();
        
        const relevantOffices = new Set();
        if (BranchValue === "") {
            allOffices.forEach(office => relevantOffices.add(office));
        } else {
            tableData.forEach(row => {
                if (String(row['Main Branch']).toLowerCase() === BranchValue) {
                    relevantOffices.add(row['Office']);
                }
            });
        }

        relevantOffices.forEach(officeName => {
            const total = officeActivityTotals.get(officeName) || 0;
            const isActive = total > 0;
            let includeByStatus = false;

            if (ActivityStatusValue === 'all') {
                includeByStatus = true;
            } else if (ActivityStatusValue === 'active' && isActive) {
                includeByStatus = true;
            } else if (ActivityStatusValue === 'inactive' && !isActive) {
                includeByStatus = true;
            }

            if (includeByStatus) {
                 officesToChart.set(officeName, total);
            }
        });
        
        chartLabels = Array.from(officesToChart.keys());
        chartValues = Array.from(officesToChart.values());
        
        if (BranchValue !== "") {
            const totalBranchActivity = Array.from(chartValues).reduce((sum, val) => sum + val, 0);
            const totalLabel = `TOTAL ${BranchValue.toUpperCase()}`;
            
            chartLabels = [totalLabel].concat(chartLabels);
            chartValues = [totalBranchActivity].concat(chartValues);
        }

    } else if (OfficeValue !== "") {
        const officeTotal = officeActivityTotals.get(OfficeValue) || 0;
        chartLabels = [OfficeValue];
        chartValues = [officeTotal];
    }


    // --- Langkah 3: Gambar Ulang Chart (dengan Sorting) ---
    if (chartLabels.length === 0) {
        drawChart({ labels: [], values: [] });
    } else {
        const chartDataResult = { labels: chartLabels, values: chartValues };
        let sortedChartData = chartDataResult;
        
        if (OfficeValue === "") {
            
            const chartDataArray = chartDataResult.labels.map((label, index) => ({
                label: label,
                value: chartDataResult.values[index]
            }));

            const totalItem = chartDataArray.find(item => item.label.startsWith('TOTAL'));
            const officeItems = chartDataArray.filter(item => !item.label.startsWith('TOTAL'));

            const activeData = officeItems.filter(item => item.value > 0);
            const inactiveData = officeItems.filter(item => item.value === 0);

            const sortedActive = sortDataByValue({
                labels: activeData.map(d => d.label),
                values: activeData.map(d => d.value)
            }, 'desc');

            const finalLabels = sortedActive.labels.concat(inactiveData.map(d => d.label));
            const finalValues = sortedActive.values.concat(inactiveData.map(d => d.value));
            
            sortedChartData = {
                labels: totalItem ? [totalItem.label].concat(finalLabels) : finalLabels,
                values: totalItem ? [totalItem.value].concat(finalValues) : finalValues,
            };
        }

        drawChart(sortedChartData);
    }

    // --- Langkah 4: Perbarui Tampilan Tabel ---
    tableBody.innerHTML = '';
    filteredData.forEach(row => {
        let tr = document.createElement('tr');
        Object.values(row).forEach(cell => {
             let td = document.createElement('td');
             td.textContent = cell;
             tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });
}

function resetFilter() {
    document.getElementById('OfficeFilter').value = "";
    document.getElementById('BranchFilter').value = "";
    document.getElementById('ActivityStatusFilter').value = "all";
    
    updateOfficeFilter("");
    filterAndSearchTable(); 
}

function printTable() {
    let tableContent = document.getElementById("dataTable").outerHTML;
    let originalContent = document.body.innerHTML;

    document.body.innerHTML = `
        <style>
            .print-btn, .filter-container { display: none; }
            h2, h3 { display: block; text-align: center; }
            table { font-size: 10px; }
        </style>
        ${document.getElementById("dataTable").outerHTML}
    `;
    window.print();
    document.body.innerHTML = originalContent;
    filterAndSearchTable(); 
}
function openPage() {
    window.location.href = 'https://bmi-apps.github.io/regionsumatera/';
}
</script>
</body>
</html>
