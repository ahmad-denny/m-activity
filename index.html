<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M|Activity Performance Region Sumatera</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        /* CSS Disederhanakan dan Digabungkan */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            padding: 20px;
            margin: 0; /* Menghilangkan margin body yang duplikat */
        }
        .container {
            width: 98%;
            max-width: 98%;
            margin: 0 auto; /* Gunakan auto untuk centering */
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
        }
        #chart-container {
            position: relative; /* Penting untuk positioning pesan loading */
            width: 98%;
            height: 300px;
            margin: 20px auto;
        }
        
        h2 {
            color: white;
            background-color: purple;
            padding: 10px;
            border-radius: 5px;
        }
        h3 {
            text-align: center;
            font-size: 13px;
            font-style: italic;
            font-weight: lighter;
            margin: 10px 0;
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 10px;
            justify-content: flex-start; /* Mengatur item dari kiri */
        }
        input[type="text"], select {
            width: auto; /* Mengubah dari 100% agar sesuai dengan flex */
            max-width: 300px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            flex-grow: 1; /* Memungkinkan elemen untuk tumbuh */
        }
        .reset-btn, .print-btn {
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        .reset-btn {
            background: darkgreen;
        }
        .print-btn {
            background: #28a745;
            margin-top: 20px;
        }
        
        /* Gaya Tabel */
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1px;
            font-size: 13px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        td {
            text-align: left;
            white-space: nowrap;
        }
        table td:nth-child(n+3){ 
            text-align: center;
        }
        th {
            background-color: purple;
            color: white;
        }
        
        /* Mobile Responsiveness Disederhanakan */
        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
            }
            input, select, .reset-btn, .print-btn {
                width: 100%; /* Membuat filter dan tombol penuh lebar di mobile */
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>M-Activity Performance Region Sumatera</h2>
        <div id="chart-container">
            <canvas id="myBarChart"></canvas>            
        </div>

        <div class="filter-container">
            <select id="BranchFilter" onchange="updateOfficeFilter(this.value)">
                <option value="">Main Branch</option>
                </select>
            <select id="OfficeFilter" onchange="filterAndSearchTable()">
                <option value="">Office</option>
                </select>
            <button class="reset-btn" onclick="resetFilter()">Reset Filter</button>
            
            <h3><p id="time-date"></p></h3>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHead"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>    
    <br>    
    </div>
    
    <button class="print-btn" onclick="printTable()">Print / Save PDF</button>

    <script src="app.js"></script>

</body>
</html>

<script>
// app.js
const ChartDataLabels = window.ChartDataLabels;
// GANTI 'nama-repo-anda' dengan nama repositori Anda. JANGAN GUNAKAN SLASH DIAKHIR.
const REPO_NAME = 'm-activity';
const BASE_PATH = './';
let myChart = null;
let tableData = [];
let allOffices = new Set(); // Tambahkan variabel global untuk menyimpan semua Office unik
let allBranches = new Set(); // Tambahkan variabel global untuk menyimpan semua Main Branch unik
    
document.addEventListener('DOMContentLoaded', function() {
    // Memuat data tabel
    fetch('Dataset.json')
        .then(response => response.json())
        .then(data => populateTable(data))
        .catch(error => console.error('Error loading JSON:', error));
        
    updateTimeDate(); // Initial time update
    setInterval(updateTimeDate, 1000); // Update every second
    drawChart(data);
});

function updateTimeDate() {
    const now = new Date();
    const time = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: "2-digit" });
    const date = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById("time-date").innerHTML = `${date} | ${time} WIB`;
}

function sortDataByValue(data, sortOrder = 'desc') {
    const pairedData = data.labels.map((label, index) => ({
        label: label,
        value: data.values[index]
    }));

    pairedData.sort((a, b) => {
        return sortOrder === 'asc' ? a.value - b.value : b.value - a.value;
    });

    const sortedLabels = pairedData.map(item => item.label);
    const sortedValues = pairedData.map(item => item.value);

    return { labels: sortedLabels, values: sortedValues };
}

function getRandomColor(alpha = 1) {
    const r = Math.floor(Math.random() * 255);
    const g = Math.floor(Math.random() * 255);
    const b = Math.floor(Math.random() * 255);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function parseCSV(text) {
    const rows = text.split('\n').filter(row => row.trim() !== '');
    const labels = [];
    const values = [];

    for (let i = 1; i < rows.length; i++) {
        const columns = rows[i].split(';');
        if (columns.length >= 2) {
            const label = columns[0].trim();
            const value = parseFloat(columns[1].trim());

            if (label && !isNaN(value)) {
                labels.push(label);
                values.push(value);
            }
        }
    }
    return { labels, values };
}

function drawChart(data) {
    const ctx = document.getElementById('myBarChart').getContext('2d');

    if (myChart) {
        myChart.destroy();
    }
    
    // Warna statis untuk chart line
    const staticColors = [
        'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)'
    ];

    myChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Office Activity',
                data: data.values,
                backgroundColor: staticColors,
                borderColor: staticColors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { beginAtZero: true, grid: { display: false }, border: { display: false }, ticks: { maxRotation: 90, minRotation: 90 } },
                y: { beginAtZero: true, grid: { display: false }, border: { display: false }, ticks: { display: false } }
            },
            plugins: {
                datalabels: {
                    color: '#000',
                    font: { weight: 'normal' },
                    anchor: 'center',
                    align: 'end',
                    formatter: (value) => value.toLocaleString()
                },
            }
        }
    });
}

// FUNGSI BARU: Dipanggil saat Main Branch berubah
function updateOfficeFilter(selectedBranch) {
    const OfficeFilter = document.getElementById('OfficeFilter');
    
    // 1. Reset Office Filter
    OfficeFilter.innerHTML = '<option value="">Office</option>'; 
    
    if (selectedBranch === "Main Branch") {
        // Jika Main Branch direset (dipilih "All"), tampilkan semua Office
        updateFilterOptions(OfficeFilter, allOffices, 'Office');
    } else {
        // 2. Saring data untuk mendapatkan Office yang relevan
        let relevantOffices = new Set();
        tableData.forEach(row => {
            // Konversi ke string agar dapat dibandingkan dengan string kosong/nilai filter
            if (String(row['Main Branch']).toLowerCase() === selectedBranch.toLowerCase()) {
                relevantOffices.add(row['Office']);
            }
        });
        
        // 3. Update dropdown Office
        updateFilterOptions(OfficeFilter, relevantOffices, 'Office');
    }

    // Panggil filterAndSearchTable untuk menyaring tabel dan chart dengan kombinasi filter baru
    filterAndSearchTable();
}
    
function populateTable(data) {
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const OfficeFilter = document.getElementById('OfficeFilter');
    const BranchFilter = document.getElementById('BranchFilter');

    tableHead.innerHTML = '';
    tableBody.innerHTML = '';
    tableData = data; // Simpan data mentah ke variabel global

    // Reset Sets global
    allOffices.clear();
    allBranches.clear();

    if (data.length > 0) {
        // ... (Kode untuk membuat header tabel) ...
        Object.keys(data[0]).forEach(header => {
            let th = document.createElement('th');
            th.textContent = header;
            tableHead.appendChild(th);
        });

        data.forEach(row => {
            // ... (Kode untuk membuat baris tabel) ...
            let tr = document.createElement('tr');
            Object.values(row).forEach(cell => {
                let td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
            
            // Isi Set global
            allOffices.add(row['Office']);
            allBranches.add(row['Main Branch']);
        });

        // Update opsi filter menggunakan Set global
        updateFilterOptions(OfficeFilter, allOffices, 'Office');
        updateFilterOptions(BranchFilter, allBranches, 'Main Branch');
    }
}

// FUNGSI UPDATE FILTER OPTIONS (Tidak berubah, tetapi menggunakan Set global sekarang)
function updateFilterOptions(filterElement, values, defaultText) {
    filterElement.innerHTML = `<option value="">${defaultText}</option>`;
    const sortedValues = Array.from(values).sort(); // Sortir secara alfabetis agar rapi
    sortedValues.forEach(value => {
        let option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        filterElement.appendChild(option);
    });
}

// app.js (MODIFIKASI PENTING PADA BAGIAN CHART)

function filterAndSearchTable() {
    const OfficeValue = document.getElementById('OfficeFilter').value.toLowerCase();
    const BranchValue = document.getElementById('BranchFilter').value.toLowerCase();
    const tableBody = document.getElementById('tableBody');

    // 1. Saring Data Mentah (Sama seperti sebelumnya)
    const filteredData = tableData.filter(row => {
        // ... (Logika penyaringan BranchMatch dan OfficeMatch)
        const BranchMatch = BranchValue === "" || String(row['Main Branch']).toLowerCase() === BranchValue;
        const OfficeMatch = OfficeValue === "" || String(row['Office']).toLowerCase() === OfficeValue;
        return BranchMatch && OfficeMatch;
    });

    // 2. Akumulasi Data untuk Chart (NEW LOGIC)
    
    // Gunakan Map untuk menyimpan total: Key = 'Main Branch', Value = Total Activity
    const branchTotals = new Map(); 
    
    // Tentukan kolom yang ingin Anda tampilkan totalnya di Chart.
    // Asumsikan kita menggunakan kolom 'Office Activity' (sesuaikan jika nama kolom berbeda)
    const COLUMN_TO_TOTAL = 'Total'; 

    filteredData.forEach(row => {
        const branchName = row['Main Branch'];
        // Pastikan nilainya adalah angka, jika tidak, anggap 0
        const activityValue = parseFloat(row[COLUMN_TO_TOTAL]) || 0; 
        
        // Akumulasi total
        const currentTotal = branchTotals.get(branchName) || 0;
        branchTotals.set(branchName, currentTotal + activityValue);
        
        // ... (Logika perbaruan Tampilan Tabel, yang sudah Anda miliki) ...
        // (Anda bisa memindahkan logika perbaruan tabel di sini, atau membiarkannya di loop terpisah)
    });
    
    // 3. Konversi Map ke Format Data Chart
    const finalLabels = Array.from(branchTotals.keys()); // Nama Main Branch
    const finalValues = Array.from(branchTotals.values()); // Total Activity per Main Branch
    
    const chartDataResult = { labels: finalLabels, values: finalValues };
    const sortedChartData = sortDataByValue(chartDataResult, 'desc');

    // 4. Gambar Ulang Grafik
    drawChart(sortedChartData);

    // 5. Perbarui Tampilan Tabel (Pindahkan logika DOM update tabel ke sini jika belum ada)
    // Logika ini memastikan tabel juga diperbarui.
    tableBody.innerHTML = '';
    filteredData.forEach(row => {
        let tr = document.createElement('tr');
        // Asumsi urutan kolom Anda
        Object.values(row).forEach(cell => {
             let td = document.createElement('td');
             td.textContent = cell;
             tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });
}

// FUNGSI FILTERANDSEARCHTABLE (Tidak perlu diubah, karena sudah dipanggil oleh updateOfficeFilter)
// ... (Biarkan fungsi filterAndSearchTable tetap sama) ...

// FUNGSI RESETFILTER (Diperbarui untuk memanggil updateOfficeFilter saat direset)
function resetFilter() {
    document.getElementById('OfficeFilter').value = "";
    document.getElementById('BranchFilter').value = "";
    
    // Panggil updateOfficeFilter dengan nilai kosong untuk mengembalikan semua opsi Office
    updateOfficeFilter(""); 
}

function printTable() {
    let tableContent = document.getElementById("dataTable").outerHTML;
    let originalContent = document.body.innerHTML;

    document.body.innerHTML = tableContent;
    window.print();
    document.body.innerHTML = originalContent;
}
</script>















