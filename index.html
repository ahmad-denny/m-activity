<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M|Activity Performance Region Sumatera</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            text-align: center;
            background-color: #f0f2f5;
            padding: 20px;
            margin: 0;
        }
        .container {
            width: 95%;
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        #chart-container {
            position: relative;
            width: 100%;
            margin: 20px auto;
            min-height: 300px; 
        }

        h2 {
            color: white;
            background: linear-gradient(90deg, #6a1b9a, #8e24aa);
            padding: 15px;
            border-radius: 8px;
            margin-top: 0;
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            outline: none;
            flex: 1;
            min-width: 150px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            color: white;
        }
        .reset-btn { background: #28a745; }
        .reset-btn:hover { background: #218838; }
        .back-btn { background: #dc3545; }
        .back-btn:hover { background: #c82333; }
        .print-btn { background: #6f42c1; }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th {
            background-color: #6a1b9a;
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
            cursor: pointer; /* Menandakan bisa diklik */
            user-select: none;
            white-space: nowrap;
        }
        th:hover {
            background-color: #4a148c;
        }
        /* Ikon panah sorting */
        .sort-icon {
            display: inline-block;
            margin-left: 8px;
            font-size: 12px;
            width: 12px;
        }
        td {
            padding: 10px;
            border: 1px solid #eee;
            text-align: left;
        }
        tr:nth-child(even) { background-color: #f9f9f9; }

        @media (max-width: 768px) {
            .filter-container { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>M-Activity Performance Region Sumatera - December 2025</h2>
    
    <div class="filter-container">
        <select id="BranchFilter">
            <option value="">Semua Main Branch</option>
        </select>
        <select id="OfficeFilter">
            <option value="">Semua Office</option>
        </select>
        <select id="ActivityStatusFilter">
            <option value="all">Semua Aktifitas</option>
            <option value="active">Ada Aktifitas</option>
            <option value="inactive">Tidak Ada Aktifitas</option>
        </select>
        
        <button class="btn reset-btn" onclick="resetFilter()">Reset</button>
        <button class="btn back-btn" onclick="openPage()">Back</button>
        <button class="btn print-btn" onclick="printTable()">Print</button>
    </div>

    <div id="chart-container">
        <canvas id="myBarChart"></canvas>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr id="tableHead"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
const ChartDataLabels = window.ChartDataLabels;
let myChart = null;
let tableData = [];
let filteredData = []; // Data yang sudah difilter tapi belum disortir
let currentSort = { column: null, direction: 'asc' }; // Status sortir

document.addEventListener('DOMContentLoaded', function() {
    const dummyData = [
        {"Main Branch": "Medan", "Office": "Medan 1", "Total": 150},
        {"Main Branch": "Medan", "Office": "Medan 2", "Total": 0},
        {"Main Branch": "Palembang", "Office": "PLM 1", "Total": 85},
        {"Main Branch": "Palembang", "Office": "PLM 2", "Total": 200},
        {"Main Branch": "Lampung", "Office": "LPG 1", "Total": 45}
    ];

    fetch('Dataset.json')
        .then(res => res.json())
        .then(data => {
            initializeDashboard(data);
        })
        .catch(err => {
            console.warn("Dataset.json tidak ditemukan, menggunakan data demo.");
            initializeDashboard(dummyData);
        });
});

function initializeDashboard(data) {
    tableData = data;
    
    // Inisialisasi Header Tabel Sekali saja
    if (data.length > 0) {
        const tableHead = document.getElementById('tableHead');
        const columns = Object.keys(data[0]);
        tableHead.innerHTML = columns.map(col => `
            <th onclick="handleSort('${col}')">
                ${col} <span id="icon-${col.replace(/\s+/g, '')}" class="sort-icon">↕</span>
            </th>
        `).join('');
        
        // Populate Filter Options
        const branches = new Set(data.map(d => d['Main Branch']));
        const offices = new Set(data.map(d => d['Office']));
        updateFilterOptions(document.getElementById('BranchFilter'), branches, 'Semua Main Branch');
        updateFilterOptions(document.getElementById('OfficeFilter'), offices, 'Semua Office');
    }

    document.getElementById('BranchFilter').addEventListener('change', (e) => {
        updateOfficeFilter(e.target.value);
        filterAndSearchTable();
    });
    document.getElementById('OfficeFilter').addEventListener('change', filterAndSearchTable);
    document.getElementById('ActivityStatusFilter').addEventListener('change', filterAndSearchTable);
    
    filterAndSearchTable();
}

function handleSort(columnName) {
    // Jika kolom yang sama diklik, balikkan arah. Jika beda, mulai dari 'asc'
    if (currentSort.column === columnName) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = columnName;
        currentSort.direction = 'asc';
    }

    // Reset semua ikon ke default
    document.querySelectorAll('.sort-icon').forEach(span => span.innerText = '↕');
    
    // Update ikon kolom yang sedang disortir
    const iconId = `icon-${columnName.replace(/\s+/g, '')}`;
    document.getElementById(iconId).innerText = currentSort.direction === 'asc' ? '▲' : '▼';

    sortAndRenderTable();
}

function sortAndRenderTable() {
    if (!currentSort.column) return;

    filteredData.sort((a, b) => {
        let valA = a[currentSort.column];
        let valB = b[currentSort.column];

        // Cek jika angka
        if (!isNaN(valA) && !isNaN(valB)) {
            valA = parseFloat(valA);
            valB = parseFloat(valB);
        }

        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });

    renderTableBody(filteredData);
}

function renderTableBody(data) {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = data.map(row => 
        `<tr>${Object.values(row).map(v => `<td>${v}</td>`).join('')}</tr>`
    ).join('');
}

function filterAndSearchTable() {
    const branchVal = document.getElementById('BranchFilter').value;
    const officeVal = document.getElementById('OfficeFilter').value;
    const statusVal = document.getElementById('ActivityStatusFilter').value;

    // Filter Data
    filteredData = tableData.filter(row => {
        const matchBranch = !branchVal || row['Main Branch'] === branchVal;
        const matchOffice = !officeVal || row['Office'] === officeVal;
        const total = parseFloat(row['Total']) || 0;
        const matchStatus = statusVal === 'all' || 
                           (statusVal === 'active' && total > 0) || 
                           (statusVal === 'inactive' && total === 0);
        return matchBranch && matchOffice && matchStatus;
    });

    // Update Chart (Chart selalu disortir manual berdasarkan nilai terbesar)
    updateChartFromData(filteredData, branchVal);
    
    // Render Tabel (Bisa disortir user melalui header)
    if (currentSort.column) {
        sortAndRenderTable();
    } else {
        renderTableBody(filteredData);
    }
}

function updateChartFromData(data, branchVal) {
    const officeMap = new Map();
    data.forEach(row => {
        officeMap.set(row['Office'], (officeMap.get(row['Office']) || 0) + (parseFloat(row['Total']) || 0));
    });

    let labels = Array.from(officeMap.keys());
    let values = Array.from(officeMap.values());

    // Sorting chart dari besar ke kecil
    const combined = labels.map((l, i) => ({l, v: values[i]})).sort((a,b) => b.v - a.v);
    let finalLabels = combined.map(d => d.l);
    let finalValues = combined.map(d => d.v);

    if (branchVal && finalValues.length > 0) {
        const total = finalValues.reduce((a, b) => a + b, 0);
        finalLabels.unshift(`TOTAL ${branchVal.toUpperCase()}`);
        finalValues.unshift(total);
    }

    drawChart({ labels: finalLabels, values: finalValues });
}

function drawChart(data) {
    const chartContainer = document.getElementById('chart-container');
    if (!data || data.labels.length === 0) {
        if (myChart) myChart.destroy();
        chartContainer.style.height = '300px';
        return; 
    }

    const barHeight = 35; 
    const calculatedHeight = (data.labels.length * barHeight) + 60;
    chartContainer.style.height = calculatedHeight + 'px';
    
    const ctx = document.getElementById('myBarChart').getContext('2d');
    if (myChart) myChart.destroy();
    
    const staticColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    const backgroundColors = data.labels.map((label, index) => {
        if (label.startsWith('TOTAL')) return '#4E337E'; 
        if (data.values[index] === 0) return '#D2D2D2';
        return staticColors[index % staticColors.length];
    });

    myChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: backgroundColors,
                borderWidth: 0,
                barPercentage: 0.7,
                categoryPercentage: 0.8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            layout: { padding: { right: 60, left: 10 } },
            scales: {
                x: { display: false, beginAtZero: true },
                y: { 
                    offset: true,
                    grid: { display: false },
                    ticks: { 
                        autoSkip: false,
                        font: { size: 12, weight: '500' },
                        padding: 10
                    }
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'right',
                    offset: 10,
                    color: '#444',
                    font: { weight: 'bold' },
                    formatter: (val) => val.toLocaleString()
                }
            }
        }
    });
}

function updateFilterOptions(el, set, def) {
    el.innerHTML = `<option value="">${def}</option>` + 
        Array.from(set).sort().map(v => `<option value="${v}">${v}</option>`).join('');
}

function updateOfficeFilter(branch) {
    const relevant = new Set();
    tableData.forEach(row => {
        if (!branch || row['Main Branch'] === branch) relevant.add(row['Office']);
    });
    updateFilterOptions(document.getElementById('OfficeFilter'), relevant, 'Semua Office');
}

function resetFilter() {
    document.getElementById('BranchFilter').value = "";
    document.getElementById('OfficeFilter').value = "";
    document.getElementById('ActivityStatusFilter').value = "all";
    currentSort = { column: null, direction: 'asc' };
    document.querySelectorAll('.sort-icon').forEach(span => span.innerText = '↕');
    updateOfficeFilter("");
    filterAndSearchTable();
}

function printTable() { window.print(); }
function openPage() { window.location.href = 'https://bmi-apps.github.io/regionsumatera/'; }
</script>
</body>
</html>
