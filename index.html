<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M|Activity Performance Region Sumatera</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        /* CSS Disederhanakan dan Digabungkan */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            padding: 20px;
            margin: 0; /* Menghilangkan margin body yang duplikat */
        }
        .container {
            width: 98%;
            max-width: 98%;
            margin: 0 auto; /* Gunakan auto untuk centering */
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
        }
        #chart-container {
            position: relative;
            width: 98%;
            height: 300px; /* HEIGHT DITENTUKAN DI SINI */
            margin: 20px auto;
        }
        
        h2 {
            color: white;
            background-color: purple;
            padding: 10px;
            border-radius: 5px;
        }
        h3 {
            text-align: center;
            font-size: 13px;
            font-style: italic;
            font-weight: lighter;
            margin: 10px 0;
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 10px;
            justify-content: flex-start; /* Mengatur item dari kiri */
        }
        input[type="text"], select {
            width: auto; /* Mengubah dari 100% agar sesuai dengan flex */
            max-width: 300px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            flex-grow: 1; /* Memungkinkan elemen untuk tumbuh */
        }
        .reset-btn, .print-btn {
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            background: green;
        }
        .reset-btn:hover {
            background: darkgreen;
        }
        .back-btn {
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            background: red;
        }
        .back-btn:hover {
            background: darkred;
        }
        .print-btn {
            background: #28a745;
            margin-top: 20px;
        }
        
        /* Gaya Tabel */
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1px;
            font-size: 13px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        td {
            text-align: left;
            white-space: nowrap;
        }
        table td:nth-child(n+3){ 
            text-align: center;
        }
        th {
            background-color: purple;
            color: white;
        }
        
        /* Mobile Responsiveness Disederhanakan */
        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
            }
            input, select, .reset-btn, .print-btn {
                width: 100%; /* Membuat filter dan tombol penuh lebar di mobile */
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>M-Activity Performance Region Sumatera</h2>
        <div id="chart-container">
            <canvas id="myBarChart"></canvas>            
        </div>

        <div class="filter-container">
            <select id="BranchFilter">
                <option value="">Main Branch</option>
                </select>
            <select id="OfficeFilter">
                <option value="">Office</option>
                </select>
            <button class="reset-btn" onclick="resetFilter()">Reset</button>
            <button class="back-btn" onclick="openPage()">Back</button>
            <h3><p id="time-date"></p></h3>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHead"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>    
    <br>    
    </div>
    
    <button class="print-btn" onclick="printTable()">Print / Save PDF</button>


</body>
</html>

<script>
// app.js
const ChartDataLabels = window.ChartDataLabels;
// GANTI 'nama-repo-anda' dengan nama repositori Anda. JANGAN GUNAKAN SLASH DIAKHIR.
const REPO_NAME = 'm-activity';
const BASE_PATH = './';
let myChart = null;
let tableData = [];
let allOffices = new Set(); // Tambahkan variabel global untuk menyimpan semua Office unik
let allBranches = new Set(); // Tambahkan variabel global untuk menyimpan semua Main Branch unik
    
document.addEventListener('DOMContentLoaded', function() {
    fetch('Dataset.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Gagal memuat Dataset.json.');
            }
            return response.json();
        })
        .then(data => {
            populateTable(data);
            // Panggil inisialisasi di sini HANYA jika berhasil dimuat
            filterAndSearchTable();
            // 2. Tambahkan event listener sekarang, setelah data siap
            document.getElementById('BranchFilter').addEventListener('change', function() {
                updateOfficeFilter(this.value);
            });
            document.getElementById('OfficeFilter').addEventListener('change', function() {
                filterAndSearchTable();
            });
        })
        .catch(error => {
            console.error('Error loading JSON:', error);
            // Jika GAGAL, panggil drawChart secara langsung dengan data kosong/error.
            // JANGAN panggil filterAndSearchTable.
            drawChart({ labels: ['Gagal Memuat Data'], values: [0] });
        });
        
    updateTimeDate(); 
    setInterval(updateTimeDate, 1000); 
    
});

function updateTimeDate() {
    const now = new Date();
    const time = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: "2-digit" });
    const date = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById("time-date").innerHTML = `${date} | ${time} WIB`;
}

function sortDataByValue(data, sortOrder = 'desc') {
    const pairedData = data.labels.map((label, index) => ({
        label: label,
        value: data.values[index]
    }));

    pairedData.sort((a, b) => {
        return sortOrder === 'asc' ? a.value - b.value : b.value - a.value;
    });

    const sortedLabels = pairedData.map(item => item.label);
    const sortedValues = pairedData.map(item => item.value);

    return { labels: sortedLabels, values: sortedValues };
}

function getRandomColor(alpha = 1) {
    const r = Math.floor(Math.random() * 255);
    const g = Math.floor(Math.random() * 255);
    const b = Math.floor(Math.random() * 255);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function parseCSV(text) {
    const rows = text.split('\n').filter(row => row.trim() !== '');
    const labels = [];
    const values = [];

    for (let i = 1; i < rows.length; i++) {
        const columns = rows[i].split(';');
        if (columns.length >= 2) {
            const label = columns[0].trim();
            const value = parseFloat(columns[1].trim());

            if (label && !isNaN(value)) {
                labels.push(label);
                values.push(value);
            }
        }
    }
    return { labels, values };
}

function drawChart(data) {
    console.log("Data yang diterima oleh drawChart:", data); // TAMBAH INI
    
    // PERIKSA: Apakah data.labels dan data.values ada dan tidak kosong?
    if (!data || data.labels.length === 0) {
        console.warn("Chart tidak digambar karena data kosong atau tidak valid.");
        // Opsional: Tampilkan pesan di canvas
        const ctx = document.getElementById('myBarChart').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return; 
    }    
    const ctx = document.getElementById('myBarChart').getContext('2d');
    const backgroundColors = data.labels.map(label => {
    if (label.startsWith('TOTAL -')) {
            // Warna khusus untuk Total Branch
            return 'rgba(78, 51, 126, 0.9)'; // Ungu/Purple yang lebih solid
        }
        // Warna default atau acak untuk Office
        return getRandomColor(0.7); 
    });
    if (myChart) {
        myChart.destroy();
    }
    
    // Warna statis untuk chart line
    const staticColors = [
        'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)'
    ];

    myChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Office Activity',
                data: data.values,
                backgroundColor: staticColors,
                borderColor: staticColors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { beginAtZero: true, grid: { display: false }, border: { display: false }, ticks: { maxRotation: 90, minRotation: 90 } },
                y: { beginAtZero: true, grid: { display: false }, border: { display: false }, ticks: { display: false } }
            },
            plugins: {
                datalabels: {
                    color: '#000',
                    font: { weight: 'normal' },
                    anchor: 'end',
                    align: 'end',
                    formatter: (value) => value.toLocaleString()
                },
            }
        }
    });
}

function updateOfficeFilter(selectedBranch) {
    const OfficeFilter = document.getElementById('OfficeFilter');
    
    // 1. Reset Office Filter
    OfficeFilter.innerHTML = '<option value="">Office</option>'; 
    
    // Jika filter Branch direset (dipilih "Main Branch" yang nilainya ""), 
    // Office akan diisi semua opsi dan chart akan menampilkan semua Main Branch (Poin 1).
    if (selectedBranch === "") {
        updateFilterOptions(OfficeFilter, allOffices, 'Office');
    } else {
        // 2. Saring data untuk mendapatkan Office yang relevan (Poin 2)
        let relevantOffices = new Set();
        tableData.forEach(row => {
            if (String(row['Main Branch']).toLowerCase() === selectedBranch.toLowerCase()) {
                relevantOffices.add(row['Office']);
            }
        });
        
        // 3. Update dropdown Office
        updateFilterOptions(OfficeFilter, relevantOffices, 'Office');
    }

    // Panggil filterAndSearchTable untuk menyaring tabel dan chart dengan kombinasi filter baru
    filterAndSearchTable();
}
    
function populateTable(data) {
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const OfficeFilter = document.getElementById('OfficeFilter');
    const BranchFilter = document.getElementById('BranchFilter');

    tableHead.innerHTML = '';
    tableBody.innerHTML = '';
    tableData = Array.isArray(data) ? data : [];

    // Reset Sets global
    allOffices.clear();
    allBranches.clear();

    if (tableData.length > 0) {
        // ... (Kode untuk membuat header tabel) ...
        Object.keys(data[0]).forEach(header => {
            let th = document.createElement('th');
            th.textContent = header;
            tableHead.appendChild(th);
        });

        data.forEach(row => {
            // ... (Kode untuk membuat baris tabel) ...
            let tr = document.createElement('tr');
            Object.values(row).forEach(cell => {
                let td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
            
            // Isi Set global
            allOffices.add(row['Office']);
            allBranches.add(row['Main Branch']);
        });

        // Update opsi filter menggunakan Set global
        updateFilterOptions(OfficeFilter, allOffices, 'Office');
        updateFilterOptions(BranchFilter, allBranches, 'Main Branch');
    }
}

// FUNGSI UPDATE FILTER OPTIONS (Tidak berubah, tetapi menggunakan Set global sekarang)
function updateFilterOptions(filterElement, values, defaultText) {
    filterElement.innerHTML = `<option value="">${defaultText}</option>`;
    const sortedValues = Array.from(values).sort(); // Sortir secara alfabetis agar rapi
    sortedValues.forEach(value => {
        let option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        filterElement.appendChild(option);
    });
}

// app.js (MODIFIKASI PENTING PADA BAGIAN CHART)

// app.js (MODIFIKASI PENTING)

    
function filterAndSearchTable() {
    // ... (Pengecekan Keamanan dan Deklarasi di awal) ...
// BARIS PENTING: Pengecekan data yang ketat.
    // Jika tableData belum terisi, HENTIKAN eksekusi.
    if (!Array.isArray(tableData) || tableData.length === 0) {
        console.warn("Filtering dibatalkan: tableData tidak valid atau kosong.");
        // Pastikan chart tetap dimuat dengan data kosong untuk menghindari error di HTML.
        drawChart({ labels: [], values: [] }); 
        return; 
    }
    const OfficeFilterElement = document.getElementById('OfficeFilter');
    const BranchFilterElement = document.getElementById('BranchFilter');

    const OfficeValue = OfficeFilterElement.value.toLowerCase();
    const BranchValue = BranchFilterElement.value.toLowerCase();
    const COLUMN_TO_TOTAL = 'Total';

    
    // --- Langkah 1: Penyaringan Dasar Data ---
    const filteredData = tableData.filter(row => {
    const BranchMatch = BranchValue === "" || String(row['Main Branch']).toLowerCase() === BranchValue;
    const OfficeMatch = OfficeValue === "" || String(row['Office']).toLowerCase() === OfficeValue;
    return BranchMatch && OfficeMatch; // <-- Logika filter harus ada di sini!
    });

    // --- Langkah 2: Logika Pengelompokan Chart ---
    
    const chartTotals = new Map();
    let chartLabels = [];
    let chartValues = [];
    let groupingKey = 'Office'; // <<< INI PERUBAHAN UTAMA: Default ke Office >>>

    const chartDataArray = Array.from(chartTotals.entries()); // Mengubah Map menjadi Array pasangan [Label, Value]
    
    // Filter data, hanya menyimpan yang nilainya > 0
    const filteredChartData = chartDataArray.filter(([label, value]) => {
        // Pastikan nilai Total Branch (yang dimulai dengan 'TOTAL') selalu ditampilkan,
        // asalkan totalnya > 0, untuk mode detail (Skenario 2).
        if (label.startsWith('TOTAL')) {
            return value > 0;
        }
        // Untuk Office biasa, pastikan nilainya > 0
        return value > 0;
    });

    // ------------------------------------------------------------------
    // KONDISI PENENTUAN GROUPING KEY UNTUK SEMUA SKENARIO
    // ------------------------------------------------------------------
    
    // Jika Branch dipilih spesifik (Skenario 2), kita menggunakan groupingKey='Office' 
    // tetapi logika perhitungannya akan berbeda (mode detail).
    
    // Jika Office spesifik dipilih (Skenario 4), groupingKey tetap 'Office'.
    if (OfficeValue !== "") {
        groupingKey = 'Office';
    } 
    
    // Jika kedua filter kosong, groupingKey sudah disetel ke 'Office' (Skenario 3/Default baru)
    // Jika BranchValue tidak kosong dan OfficeValue kosong, kita masuk Skenario 2 (detail)
    
    // ------------------------------------------------------------------
    // SKENARIO 2: Branch spesifik dipilih, Office (All) dipilih (Mode Detail Branch)
    // ------------------------------------------------------------------
    if (BranchValue !== "" && OfficeValue === "") {
        
        let totalBranchActivity = 0;
        
        // Hitung total per Office di bawah Branch spesifik
        filteredData.forEach(row => {
            const officeName = row['Office'];
            const activityValue = parseFloat(row[COLUMN_TO_TOTAL]) || 0;
            
            const currentOfficeTotal = chartTotals.get(officeName) || 0;
            chartTotals.set(officeName, currentOfficeTotal + activityValue);

            totalBranchActivity += activityValue;
        });

        // Susun Labels Poin 2 (TOTAL Branch + Offices)
        const totalLabel = `TOTAL ${BranchValue.toUpperCase()}`;
        chartTotals.set(totalLabel, totalBranchActivity);
        
        const officeLabels = Array.from(chartTotals.keys()).filter(k => !k.startsWith('TOTAL'));
        chartLabels = [totalLabel].concat(officeLabels);
        chartValues = chartLabels.map(label => chartTotals.get(label));
                
        // Kita lompat ke Langkah 3 karena chartLabels sudah terisi
        
    } else {
        // ----------------------------------------------------
        // LOGIKA PENGELOMPOKAN DEFAULT (Skenario 1, 3, dan 4)
        // ----------------------------------------------------
        
        // Skenario 1/3 (Branch All, Office All) dan Skenario 4 (Office Spesifik)
        // Keduanya sekarang menggunakan groupingKey = 'Office'
        
        filteredData.forEach(row => {
            const groupKey = row[groupingKey]; 
            const activityValue = parseFloat(row[COLUMN_TO_TOTAL]) || 0; 
            
            const currentTotal = chartTotals.get(groupKey) || 0;
            chartTotals.set(groupKey, currentTotal + activityValue);
        });
        
        chartLabels = Array.from(chartTotals.keys()); 
        chartValues = Array.from(chartTotals.values());
        
        // KHUSUS SKENARIO 1 (Jika pengguna benar-benar ingin melihat Main Branch)
        if (BranchValue === "" && OfficeValue === "" && BranchFilterElement.value === "") {
             // Jika kedua filter kosong dan pengguna belum menyentuh filter Office, 
             // kita kembali ke pengelompokan Main Branch.
             
             // PERHATIAN: Logika ini bergantung pada bagaimana filter disajikan. 
             // Untuk memenuhi permintaan "default tampilkan total semua Office", 
             // kita TIDAK PERLU lagi memproses Main Branch di sini.
        }
    }

    // --- Langkah 3: Gambar Ulang Chart ---
    
    if (chartLabels.length === 0) {
         drawChart({ labels: [], values: [] });
    } else {
        const chartDataResult = { labels: chartLabels, values: chartValues };
        
        let sortedChartData = chartDataResult;
        // Hanya sortir jika BUKAN mode detail (Poin 2)
        if (!(BranchValue !== "" && OfficeValue === "")) {
            sortedChartData = sortDataByValue(chartDataResult, 'desc'); 
        }

        
        drawChart(sortedChartData); 
    }

    // --- Langkah 4: Perbarui Tampilan Tabel ---
    // Logika ini memastikan tabel juga diperbarui.
    tableBody.innerHTML = '';
    filteredData.forEach(row => {
        let tr = document.createElement('tr');
        Object.values(row).forEach(cell => {
             let td = document.createElement('td');
             td.textContent = cell;
             tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });
}

// FUNGSI FILTERANDSEARCHTABLE (Tidak perlu diubah, karena sudah dipanggil oleh updateOfficeFilter)
// ... (Biarkan fungsi filterAndSearchTable tetap sama) ...

// FUNGSI RESETFILTER (Diperbarui untuk memanggil updateOfficeFilter saat direset)
function resetFilter() {
    document.getElementById('OfficeFilter').value = "";
    document.getElementById('BranchFilter').value = "";
    
    // Panggil updateOfficeFilter dengan nilai kosong untuk mengembalikan semua opsi Office
    updateOfficeFilter("");
    filterAndSearchTable(); 
}

function printTable() {
    let tableContent = document.getElementById("dataTable").outerHTML;
    let originalContent = document.body.innerHTML;

    document.body.innerHTML = tableContent;
    window.print();
    document.body.innerHTML = originalContent;
}
function openPage() {
    window.location.href = 'https://bit.ly/AppRegionSumatera';
}
</script>
